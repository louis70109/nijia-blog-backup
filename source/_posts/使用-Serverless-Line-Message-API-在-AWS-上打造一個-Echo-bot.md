---
title: ä½¿ç”¨ Serverless & Line Message API åœ¨ AWS ä¸Šæ‰“é€ ä¸€å€‹ Echo bot
date: 2019-10-31 16:20:12
tags: ["Serverless", "LINE", "AWS"]
categories: Serverless
---


# å‰è¨€
Serverless æ¶æ§‹æ˜¯ä¸€å€‹åŸºæ–¼ FaaS(Function as a Service) å¯¦ä½œçš„ä¸€å€‹æœå‹™ï¼Œè®“é–‹ç™¼è€…å¯ä»¥æ›´å°ˆæ³¨åœ¨é–‹ç™¼åŠŸèƒ½ï¼Œå°‡ yml æª”è¨­å®šå¥½å…¶é¤˜ç¶­é‹çš„å•é¡Œéƒ½äº¤çµ¦ AWSã€Googleã€Azure é€™äº›æœå‹™å•†å»è™•ç†ï¼Œåªè¦æŠŠä¿¡ç”¨å¡æº–å‚™å¥½å°±å¥½(?)ï¼Œè®“é–‹ç™¼è€…åœ¨å¯«å®Œç¨‹å¼ä¹‹å¾Œä¸ç”¨ç…©æƒ±éƒ¨ç½²å¾—å•é¡Œï¼Œæ¸›å°‘çš„ä¸å°‘çš„éº»ç…©äº‹ã€‚
é‚£å› ç‚ºç¾ä»»å…¬å¸çš„æœå‹™éƒ½æ˜¯åŸºæ–¼ AWSï¼Œå¦‚æ­¤é€™èˆ¬æˆ‘å°±æ¥è§¸åˆ° Serverless(ä»¥ä¸‹ç°¡ç¨± sls) é€™å€‹æ¡†æ¶å•¦ (æƒ³æ›´æ·±å…¥äº†è§£ FaaS æ¶æ§‹å¯ä»¥åƒè€ƒ AWS)
[2019/07/04 æ›´æ–°]
è‹¥å·²ç¶“æš¸è§£çš„æœ‹å‹å¯ä»¥åƒè€ƒæˆ‘çš„ python ç‰ˆæœ¬:
[louis70109/aws-line-echo-bot](https://github.com/louis70109/aws-line-echo-bot)
Ruby çš„ç¯„ä¾‹ç‰ˆæœ¬:
[louis70109/aws-ruby-line-echo-bot](https://github.com/louis70109/aws-ruby-line-echo-bot)

# ç‚ºä»€éº¼è¦ Serverless
[2019/06/29 æ›´æ–°]
ä»¥ç”¨ä¸€å€‹ Ruby on Rails å¯«çš„æ©Ÿå™¨äººç‚ºä¾‹ï¼Œåœ¨å¯«å®Œå€‹ webhook function å¾Œï¼Œè¨­å®šè·¯ç”±ç„¶å¾Œéƒ¨ç½²ï¼Œä¸€èˆ¬ä¸»æ©Ÿæˆ–æ˜¯è™›æ“¬æ©Ÿå°±å¾ˆéº»ç…©ï¼Œè¦å®‰è£ä½ˆç½²ç’°å¢ƒä»¥åŠä¸€å®‰è£å †ç›¸é—œå¥—ä»¶ï¼Œå®Œäº†ä¹‹å¾Œè¨­å®š Domain ä»€éº¼çš„æœ‰å¤ èŠ±æ™‚é–“ã€‚ä½†è‹¥æ˜¯ä½¿ç”¨ heroku éƒ¨ç½²å°±å¾ˆæ–¹ä¾¿ï¼ŒLogin â€” Create-Deploy é¦¬ä¸Šå°±çµæŸï¼Œæ©Ÿå™¨äººé¦¬ä¸Šå°±ä¸Šç·šäº†ï¼Œå¯¦åœ¨æ˜¯ä¿—åˆå¤§ç¢—å‘€ï½
ä½†æˆ‘è¦ºå¾—åƒæ˜¯ Line Message é€™ç¨® stateless çš„æœå‹™ï¼Œä¸”åªè¦ä¸€å€‹ function + route å°±èƒ½å¯¦ä½œçš„ç¨‹å¼æœ€é©åˆ Serverless äº†ï¼Œè®“å°ˆæ¡ˆå¯ä»¥ç°¡æ½”æœ‰åŠ›ï¼Œåªè¦å¯«ä¸€å€‹ function+yml è¨­å®šä¸¦æ‰“å€‹æŒ‡ä»¤å°±éƒ¨ç½²äº†ï¼Œè€Œä¸” domain é‚„é™„è´ˆ SSLï¼Œå°‡æœå‹™äº¤çµ¦ AWS ä¹Ÿä¸éœ€è¦æ“”å¿ƒï¼Œæ•´å€‹å°±æ˜¯è¶…ç´šæ–¹ä¾¿å•Šï¼
Cold start time å•é¡Œï¼Œä¾ç…§æˆ‘ç›®å‰ä½¿ç”¨çš„çµæœä¸‹ä¾†ï¼Œåœ¨ heroku ä»¥åŠ AWS Lambda åŒæ™‚ç¡è‘—çš„æƒ…æ³ä¸‹ï¼ŒAWS èµ·åºŠçš„å›æ‡‰é€Ÿåº¦å¤§æ¦‚ 1 ç§’å·¦å³ï¼Œè€Œ heroku å‰‡å¤§æ¦‚è½åœ¨ 10~15 ç§’(åƒè€ƒ)ã€‚å¦‚ä¸‹åœ–æ‰€ç¤ºçš„å…è²»æ–¹æ¡ˆï¼ŒåŸºæœ¬ä¸Šé–‹ç™¼éšæ®µæ‡‰è©²æ˜¯ä¸è‡³æ–¼åˆ° 100 è¬/æœˆ å€‹è«‹æ±‚å§ğŸ˜†ï¼Œæ‰€ä»¥é€™éƒ¨åˆ†å°±åˆ¥æ“”æ–°å¤§åŠ›åœ°çµ¦ä»–ç”¨ä¸‹å»ï½ (æ„Ÿè¬ petertc å¹«å¿™æ‰¾é€™æ–¹é¢çš„å•é¡ŒğŸ’ª)

AWS Lambda å…è²»æ–¹æ¡ˆ
æ¥ä¸‹ä¾†å°±è®“æˆ‘ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ sls + Line Message API å»ºç«‹ä¸€å€‹ Echo bot å§ï¼
![](https://i.imgur.com/pNCDY4e.png)

# ç’°å¢ƒ
npm 6.9.0
python 3.7.3
serverless 1.45.1

# å»ºç«‹ AWS å­˜å–é‡‘é‘°
é¦–å…ˆè¦å…ˆæœ‰å€‹ AWS å¸³è™Ÿ(å»¢è©±) ï¼Œå¦‚æœæ²’æœ‰ç¶å®šä¿¡ç”¨å¡è¨˜å¾—å»ç¶å®šæ‰èƒ½ç¹¼çºŒï¼Œæ¥ä¸‹ä¾†å°±å¯ä»¥å»å°±å¯ä»¥å»å»ºç«‹é‘°åŒ™å›‰ï¼
![](https://i.imgur.com/XHuvbyX.png)
å¦‚ä¸Šåœ–ï¼ŒæŒ‰ä¸‹ç´…è‰²æ¡†æ¡†çš„éƒ¨åˆ†ï¼Œæ¥è‘—æŒ‰ç®­é ­æŒ‡çš„æŒ‰éˆ•ï¼Œå°±æœƒå»ºç«‹ä¸€å€‹æˆ‘å€‘è¦çš„é‡‘é‘°å›‰ï¼
![AWS secret & ID key](https://i.imgur.com/FzRCna0.png)

å¦‚ä¸Šåœ–æ‰€ç¤ºï¼Œå¯ä»¥ä¸‹è¼‰ keyï¼ŒAWS ä¸æœƒå¹«å¿™ä¿å­˜ Secret keyï¼Œè‹¥é€™è¦–çª—é—œæ‰çš„è©± key å°±ä¸è¦‹äº†ï¼Œæ‰€ä»¥ä½¿ç”¨è€…å¯ä»¥è‡ªè¡Œä¸‹è¼‰æª”æ¡ˆä¿å­˜ï¼Œä»¥å…å“ªå¤©è¦éƒ¨ç½²çš„æ™‚å€™æ‰¾ä¸åˆ° keyã€‚
æ¥è‘—å°±å°‡é€™å…©å€‹åƒæ•¸åŠ å…¥ç’°å¢ƒè®Šæ•¸ä¸­ï¼š
```bash
export AWS_ACCESS_KEY_ID=<your-key-here>
export AWS_SECRET_ACCESS_KEY=<your-secret-key-here>
```
# Serverless å»ºç«‹èˆ‡éƒ¨ç½²
é¦–å…ˆå…ˆé€éä»¥ä¸‹æŒ‡ä»¤è®“ npm å¹«å¿™å®‰è£ sls çš„æŒ‡ä»¤ã€‚
```bash
npm install serverless -g
```
å®‰è£å®Œä¹‹å¾Œå°±é€é sls æŒ‡ä»¤ä¾†å»ºç«‹å°ˆæ¡ˆåš•ï¼
```bash
serverless create â€” template aws-python â€” path aws-line-echo-bot
```
> severless æŒ‡ä»¤å¯ä»¥ç¸®å¯«æˆ sls
> template = æƒ³ç”¨ä»€éº¼å¹³å°ä»¥åŠèªè¨€å°±åœ¨æ­¤æ¨¡æ¿äº† (åƒè€ƒ)
> path = æª”æ¡ˆåç¨±

![](https://i.imgur.com/2KNweWB.png)
![](https://i.imgur.com/HDonmjF.png)

é€é severless å»ºç«‹å°ˆæ¡ˆæŒ‡ä»¤
ä¾ç…§ä¸åŒçš„ template å¯èƒ½æœƒå»ºç«‹ N å€‹æª”æ¡ˆï¼Œä½†ä¸»è¦é‚„æ˜¯ä»¥ä¸‹ä¸‰å€‹æª”æ¡ˆ
```bash
.gitignore 
handler.py = ä¸»ç¨‹å¼çš„åœ°æ–¹
serverless.yml = æ‰€æœ‰è¨­å®šéƒ½åœ¨é€™è£¡ï¼Œfuntion åƒæ•¸æœƒå°æ‡‰åˆ°æŒ‡å®šçš„è·¯ç”±
```
åœ¨éƒ¨ç½²å‰é ˆè‡³ serverless.yml è£¡ï¼ŒæŠŠ runtime çš„ python2.7 æ”¹è‡³ 3.7ï¼Œå¦å‰‡æœƒå› ç‰ˆæœ¬å•é¡Œå°è‡´éŒ¯èª¤ã€‚
```bash
serverless deploy # sls deploy
```
![Serverless éƒ¨ç½²ç•«é¢](https://i.imgur.com/18Fnran.png)

æ¥è‘—åˆ° AWS Lambda ä»¥åŠ S3 å°±å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡éƒ¨ç½²å®Œçš„ç¨‹å¼ä»¥åŠæª”æ¡ˆå›‰ï¼

# åŠ å…¥ Line Message API
æ—¢ç„¶æ˜¯å¯« pythonï¼Œé‚£ä¸€å®šæ˜¯è¦ç”¨ line-python-sdk
ç…§è‘—å®˜æ–¹ç”¨æ³•æ‡‰è©²æ˜¯è¦åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å®‰è£å¥—ä»¶
```bash
pip install line-bot-sdk
```
ä¸éæˆ‘å€‘æ˜¯è¦éƒ¨ç½²åˆ° AWS çš„ Lambda ä¸Šï¼Œä¸”å› ç‚ºä»–æ˜¯ç„¡ä¼ºæœå™¨é‹ç®—çš„æœå‹™ï¼Œæ‰€ä»¥ä»–æ²’è¾¦æ³•è·‘ pip å»å¹«æˆ‘å®‰è£å¥—ä»¶ã€‚
æ­¤æ™‚å°±è¦å‡ºå‹• requirements.txt ä¾†ç®¡ç†ç›¸ä¾å¥—ä»¶ ï¼Œä½†åªæœ‰åŠ å…¥å®ƒ sls æ ¹æœ¬ä¸èªè­˜ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦å®‰è£ pulgin ä¾†è®“ sls èªå¾—(requirements.txt)ã€‚
```bash
sls plugin install -n serverless-python-requirements
```
![](https://i.imgur.com/0NFfVi6.png)

---

![](https://i.imgur.com/pS7s8ls.png)

å®‰è£æŒ‡ä»¤ & package.json
å¦‚åœ–ï¼Œå®‰è£éç¨‹ä¸­æœƒè‡ªå‹•å»ºç«‹ package.jsonï¼Œä¸”æœƒå¹«å¿™åœ¨ serverless.yml è£¡é¢åŠ å…¥ pulginï¼Œé€™æ¨£ sls åœ¨éƒ¨ç½²æ™‚å°±èªå¾— requirements.txt å›‰ï¼
æ¥è‘—å°‡ Line SDK åŠ å…¥ requirements.txtï¼Œ AWS å°±æœƒå¹«å¿™å®‰è£å¥—ä»¶äº†ã€‚
```bash
echo "line-bot-sdk==1.12.1" > requirements.txt
```
ç„¶å¾Œæ–°å¢ä¸€å€‹ setup.cfg ä¸¦åŠ å…¥ä»¥ä¸‹å…§å®¹ï¼š
```bash
[install]
prefix=
```
ç”±æ–¼ AWS Lambda ä¸Šéƒ½æœƒå°‡å¥—ä»¶å®‰è£åœ¨æœ¬åœ°ç«¯(Lambda ä¸Š)ï¼Œå› æ­¤åœ¨åŸ·è¡Œ pip install -t . -r requirements.txt æ™‚æœƒéœ€è¦ setup.cfgã€‚
è‡³æ–¼è©³ç´°åŸå› å˜›ï½é‚„æœ‰è«‹å„ä½å¤§å¤§å¹«å°å¼Ÿè§£ç­” ğŸ™
æœ€å¾Œå°±è™•ç† handler.py ä»¥åŠ serverless.yml å›‰ï¼
å°‡ä¸Šè¿°å…©å€‹ gist åˆ†åˆ¥è²¼åˆ°è‡ªå·±çš„ handler.py & serverless.ymlï¼Œåœ¨ hanlder.py è£¡çš„ CHANNEL KEY & TOKEN è¨˜å¾—æ›æˆè‡ªå·±çš„æ©Ÿå™¨äººğŸ‘¾å“¦ï¼
![ä½ˆå±¬å®Œç‹€æ…‹](https://i.imgur.com/WVBHxL3.png)
æ¥è‘—åœ¨åŸ·è¡Œä¸€æ¬¡ sls deployï¼Œå°‡ç¨‹å¼éƒ¨ç½²ä¸Šå»ï¼Œå¦‚ä¸Šåœ–æ‰€ç¤ºï¼Œåœ¨ endpoints é‚£è¡Œæœƒæœ‰ä¸€å€‹ç¶²å€ï¼Œå°‡é‚£ç¶²å€æ”¾åˆ° Line Webhook URL ä¸Šä¸¦ Verify çœ‹çœ‹æœ‰æ²’æœ‰æˆåŠŸï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚
![](https://i.imgur.com/CQMwc8V.png)
æœ€å¾Œå°è‘—è‡ªå·±çš„æ©Ÿå™¨äººç™¼å€‹è©±ï¼Œçœ‹ä»–æœ‰æ²’æœ‰å›æ‡‰ä½ ä¸€æ¨¡ä¸€æ¨£çš„æ–‡å­—ï¼Œè‹¥æˆåŠŸäº†å°±èƒ½å¾€ä¸‹ä¸€æ­¥æ‡‰ç”¨å±¤ç¹¼çºŒé–‹ç™¼å›‰ï¼è‹¥å¤±æ•—äº†å°±è¦æª¢æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯æœ‰å“ªå€‹æ­¥é©ŸåšéŒ¯äº†ï½
# çµè«–
å› ç‚ºå…¬å¸çš„ç·£æ•…è®“æˆ‘èƒ½å¤ æ¥è§¸åˆ°é€™ç¥å¥‡çš„ Serverlessï¼Œç¶“éé€™æ¬¡çš„åˆ†äº«åŠ æ·±æˆ‘å°æ–¼ FaaS çš„æ¶æ§‹æ›´åŠ äº†ç†Ÿæ‚‰ï¼Œç”±æ–¼æˆ‘ä¹Ÿæ˜¯åˆç¢°ï¼Œæˆ‘èªç‚ºä½¿ç”¨ä¸Šå¯ä»¥æŠŠå®ƒç•¶ä½œæ˜¯ä¸€å€‹ Docker çš„å®¹å™¨æˆ–è¨±æ¦‚å¿µä¸Šæœƒæ¯”è¼ƒå¥½ç†è§£ï¼Œå¾ŒçºŒé‚„æœ‰å¾ˆå¤šçš„è¨­å®šæª”éƒ½é‚„æ²’è©³ç´°ç ”ç©¶ï¼Œæœ€è¿‘è®“æˆ‘å…ˆç ”ç©¶ç ”ç©¶ä¸€ä¸‹å†ä¸Šä¾†åˆ†äº«ã€‚

>æ–‡ç« ä¸­æœ‰ä»»ä½•å‹˜èª¤æ­¡è¿æŒ‡æ­£

å¦‚æœè¦ºå¾—é€™ç¯‡æ–‡ç« æœ‰å¹«åŠ©çš„è©±è«‹çµ¦æˆ‘å€‹æŒè²é¼“å‹µæˆ‘ä¸€ä¸‹ğŸ‘‹
ä¸‹åˆ—æ˜¯æˆ‘çš„é€™æ¬¡å¯¦ä½œçš„å°ˆæ¡ˆï¼Œå¦‚æœæœ‰å¹«åŠ©ä¹Ÿä¾†é¡†æ˜Ÿæ˜Ÿå§ï¼
[louis70109/aws-line-echo-bot](https://github.com/louis70109/aws-line-echo-bot?source=post_page-----1e3e785a2a01----------------------)

# åƒè€ƒ
- [AWS Lambda è²»ç‡å•é¡Œ](https://aws.amazon.com/tw/lambda/pricing/)
- [Serverless GitHub](https://github.com/serverless/serverless)
- [Serverless Python Requirements](https://serverless.com/plugins/serverless-python-requirements/)
- [Line Python SDK](https://github.com/line/line-bot-sdk-python)
- [FaaS æ¦‚å¿µ](https://aws.amazon.com/cn/blogs/china/iaas-faas-serverless/)
- [AWS, GCP, Azure cold start time](https://mikhail.io/2018/08/serverless-cold-start-war/)