name: Hexo Build and Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  Install-Node-package:
    name: Install Node package
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@master
        with:
          submodules: true
      - name: Add SSH key
        env:
            SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
            mkdir -p /home/runner/.ssh
            ssh-keyscan example.com >> /home/runner/.ssh/known_hosts
            chmod 600 /home/runner/.ssh/github_actions
            ssh-agent -a $SSH_AUTH_SOCK > /dev/null	
            ssh-add /home/runner/.ssh/github_actions
      - name: Cache node modules
        uses: actions/cache@v1
        id: cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-    
      # Deploy hexo blog website.
      - name: Deploy
        id: deploy
        uses: sma11black/hexo-action@v1.0.3
        with:
          deploy_key: ${{ secrets.BLOG_DEPLOY_TOKEN }}
          commit_msg: ${{ github.event.head_commit.message }}  # (or delete this input setting to use hexo default settings)
      # Use the output from the `deploy` step(use for test action)
      - name: Get the output
        run: |
          echo "${{ steps.deploy.outputs.notify }}"
      - name: success deploy
        if: ${{ success() }}
        run: |
          curl -v -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_BOT_TOKEN }}" \
            -d '{
                    "to": "${{ secrets.ADMIN_LINE_ID }}",
                    "messages":[{
                      "type": "flex",
                      "altText": "‚úÖ Blog",
                      "contents": {
                      "type": "bubble",
                      "hero": {
                        "type": "image",
                        "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png",
                        "size": "full",
                        "aspectRatio": "20:13",
                        "aspectMode": "cover"
                      },
                      "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                          {
                            "type": "text",
                            "text": "${{ github.repository }}",
                            "weight": "bold",
                            "size": "xl",
                            "wrap": true
                          }
                        ]
                      },
                      "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                          {
                            "type": "button",
                            "style": "link",
                            "height": "sm",
                            "action": {
                              "type": "uri",
                              "label": "üìù Draft",
                              "uri": "https://github.com/louis70109/nijia-blog-backup/tree/master/source/_drafts"
                            }
                          },
                          {
                            "type": "button",
                            "style": "link",
                            "height": "sm",
                            "action": {
                              "type": "uri",
                              "label": "üåª Blog",
                              "uri": "https://nijialin.com/"
                            }
                          }
                        ],
                        "flex": 0
                      }
                    }
                  }]
                }'
      - name: send failure message
        if: ${{ failure() }}
        uses: louis70109/line-notify-action@master
        with:
          token: ${{ secrets.LINE_NOTIFY_TOKEN }}
          message: 'üî• Blog deploy failure. Check Action: https://github.com/louis70109/nijia-blog-backup/actions'
      - name: fail deploy
        if: ${{ failure() }}
        run: |
          curl -v -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_BOT_TOKEN }}" \
            -d '{
                    "to": "${{ secrets.ADMIN_LINE_ID }}",
                    "messages":[{
                      "type": "flex",
                      "altText": "üî• Blog",
                      "contents": {
                      "type": "bubble",
                      "hero": {
                        "type": "image",
                        "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png",
                        "size": "full",
                        "aspectRatio": "20:13",
                        "aspectMode": "cover"
                      },
                      "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                          {
                            "type": "text",
                            "text": "${{ github.repository }}",
                            "weight": "bold",
                            "size": "xl",
                            "wrap": true
                          }
                        ]
                      },
                      "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                          {
                            "type": "button",
                            "style": "link",
                            "height": "sm",
                            "action": {
                              "type": "uri",
                              "label": "üìù Draft",
                              "uri": "https://github.com/louis70109/nijia-blog-backup/tree/master/source/_drafts"
                            }
                          },
                          {
                            "type": "button",
                            "style": "link",
                            "height": "sm",
                            "action": {
                              "type": "uri",
                              "label": "üåª Blog",
                              "uri": "https://nijialin.com/"
                            }
                          },
                          {
                            "type": "button",
                            "style": "link",
                            "height": "sm",
                            "action": {
                              "type": "uri",
                              "label": "‚õÖÔ∏è Actions",
                              "uri": "https://github.com/louis70109/nijia-blog-backup/actions"
                            }
                          },
                          {
                            "type": "button",
                            "style": "link",
                            "height": "sm",
                            "action": {
                              "type": "message",
                              "label": "‚è∞ Deploy",
                              "text": "ReRun ${{ github.repository }} ${{ github.run_id }}"
                            }
                          }
                        ],
                        "flex": 0
                      }
                    }
                  }]
                }'
